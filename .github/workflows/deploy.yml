name: Deploy Knowledge Base

on:
  push:
    branches: [ main, initial-knowledge-base ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-validate:
    runs-on: ubuntu-latest
    name: ğŸ” Lint and validate content
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML structure
      run: |
        echo "ğŸ” Validating HTML files..."
        total_files=$(find . -name "*.html" -not -path "./node_modules/*" | wc -l)
        echo "Found $total_files HTML files"
        
        # Check for basic HTML structure
        for file in $(find . -name "*.html" -not -path "./node_modules/*"); do
          if ! grep -q "<!DOCTYPE html>" "$file"; then
            echo "âš ï¸  Missing DOCTYPE in: $file"
          fi
          if ! grep -q "<title>" "$file"; then
            echo "âš ï¸  Missing title in: $file"
          fi
        done
        echo "âœ… HTML validation complete"
    
    - name: Check assets structure
      run: |
        echo "ğŸ“ Checking assets structure..."
        if [ -d "assets/" ]; then
          css_files=$(find assets/ -name "*.css" | wc -l)
          js_files=$(find assets/ -name "*.js" | wc -l)
          echo "Found $css_files CSS files and $js_files JS files"
        else
          echo "âš ï¸  Assets directory not found"
        fi
    
    - name: Verify knowledge base sections
      run: |
        echo "ğŸ“š Verifying knowledge base sections..."
        sections=("ai-engineering" "tech" "business" "philosophy" "people")
        for section in "${sections[@]}"; do
          if [ -d "$section/" ]; then
            count=$(find "$section/" -name "*.html" | wc -l)
            echo "âœ… $section: $count files"
          else
            echo "âš ï¸  Section missing: $section"
          fi
        done

  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security scan
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for HTTrack metadata
      run: |
        echo "ğŸ§¹ Checking for cleaned HTTrack metadata..."
        if grep -r "HTTrack" --include="*.html" .; then
          echo "âš ï¸  HTTrack metadata still found - run clean_httrack_metadata.sh"
          exit 1
        else
          echo "âœ… No HTTrack metadata found - files are clean"
        fi
    
    - name: Scan for sensitive information
      run: |
        echo "ğŸ”’ Scanning for sensitive information..."
        if grep -r -i "password\|secret\|api.key\|token" --include="*.html" --include="*.js" --include="*.css" . | grep -v "example\|placeholder\|demo"; then
          echo "âš ï¸  Potential sensitive information found - please review"
        else
          echo "âœ… No sensitive information detected"
        fi

  deploy-staging:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to staging
    needs: [lint-and-validate, security-scan]
    if: github.ref == 'refs/heads/initial-knowledge-base'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Knowledge base would be available at: https://staging.zaylegend.com/knowledge-base"
        echo "âœ… Staging deployment complete"

  deploy-production:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy to production
    needs: [lint-and-validate, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      run: |
        echo "ğŸŒ Deploying to production..."
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Knowledge base deployed to: https://zaylegend.com/knowledge-base"
        echo "ğŸ“Š Content sections:"
        echo "  - AI Engineering Course (7 weeks)"
        echo "  - Technical Documentation"
        echo "  - Session Recaps"
        echo "  - Business Resources"
        echo "  - Philosophy & Learning"
        echo "âœ… Production deployment complete"

  summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š Deployment summary
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "ğŸ“š Knowledge Base Deployment Summary"
        echo "===================================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Workflow: ${{ github.workflow }}"
        echo ""
        echo "ğŸ¯ Knowledge Base Features:"
        echo "  âœ… Professional HTML formatting (HTTrack cleaned)"
        echo "  âœ… AI Engineering Course content"
        echo "  âœ… Detailed session recaps"
        echo "  âœ… Technical documentation"
        echo "  âœ… Security scanned"
        echo ""
        if [ "${{ github.ref_name }}" = "main" ]; then
          echo "ğŸŒ Live at: https://zaylegend.com/knowledge-base"
        else
          echo "ğŸš€ Staging deployment for branch: ${{ github.ref_name }}"
        fi
