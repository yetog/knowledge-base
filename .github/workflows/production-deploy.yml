name: Deploy Knowledge Base to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy-to-server:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production Server
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate HTML files
      run: |
        echo "ğŸ” Validating HTML structure..."
        total_files=$(find . -name "*.html" -not -path "./.git/*" | wc -l)
        echo "Found $total_files HTML files to validate"
        
        # Basic validation
        for file in $(find . -name "*.html" -not -path "./.git/*"); do
          if ! grep -q "<!DOCTYPE html>" "$file"; then
            echo "âš ï¸  Missing DOCTYPE in: $file"
          fi
        done
        
    - name: ğŸ”’ Security scan
      run: |
        echo "ğŸ”’ Scanning for security issues..."
        if grep -r "password\|secret\|api.*key" --include="*.html" --include="*.js" --include="*.css" . | grep -v "example\|demo\|placeholder"; then
          echo "âš ï¸  Potential sensitive data found - review before deploy"
          exit 1
        fi
        echo "âœ… Security scan passed"
        
    - name: ğŸš€ Deploy to production server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment to knowledge base..."
          
          # Navigate to knowledge base directory
          cd /var/www/zaylegend/apps/knowledge-base
          
          # Backup current version
          sudo cp -r . ../knowledge-base-backup-$(date +%Y%m%d-%H%M%S) || echo "Backup creation failed, continuing..."
          
          # Fetch and pull latest changes
          echo "ğŸ“¥ Fetching latest changes from GitHub..."
          git fetch origin main
          git reset --hard origin/main
          
          # Ensure correct permissions
          echo "ğŸ”§ Setting correct permissions..."
          sudo chown -R langchain:www-data .
          find . -type f -name "*.html" -exec chmod 644 {} \;
          find . -type f -name "*.css" -exec chmod 644 {} \;
          find . -type f -name "*.js" -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          
          # Test nginx configuration
          echo "ğŸ” Testing nginx configuration..."
          sudo nginx -t
          
          # Reload nginx to ensure changes take effect
          echo "ğŸ”„ Reloading nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Knowledge base deployment completed successfully!"
          echo "ğŸŒ Live at: https://zaylegend.com/knowledge-base/"
          
    - name: ğŸ¯ Deployment summary
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "===================="
        echo "ğŸ¯ Repository: knowledge-base"
        echo "ğŸŒ Environment: Production"
        echo "ğŸ“… Deployed at: $(date)"
        echo "ğŸ”— Live URL: https://zaylegend.com/knowledge-base/"
        echo "âœ… Status: Success"

  update-portfolio-submodule:
    needs: deploy-to-server
    runs-on: ubuntu-latest
    name: ğŸ“¦ Update Portfolio Submodule
    
    steps:
    - name: ğŸ”„ Update portfolio submodule
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸ“¦ Updating portfolio submodule..."
          cd /var/www/zaylegend/portfolio
          
          # Update the submodule to point to latest main
          git submodule update --remote apps/knowledge-base
          git add apps/knowledge-base
          
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ¤– Auto-update knowledge-base submodule from main branch

            Updated knowledge-base submodule to latest main branch.
            This ensures portfolio repo stays in sync with knowledge base updates.
            
            ğŸ¤– Generated with [GitHub Actions]"
            
            echo "âœ… Portfolio submodule updated successfully"
          else
            echo "â„¹ï¸  No submodule changes to commit"
          fi